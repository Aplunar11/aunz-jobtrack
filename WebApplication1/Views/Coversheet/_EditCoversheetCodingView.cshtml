@model JobTrack.Models.Coversheet.CoversheetData
@using JobTrack.Models.Enums

<div class="modal fade" id="modal-coversheet" tabindex="-1" role="dialog" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header" style="background-color:#009688;color:white">
                <h6 class="modal-title" id="confirmModalLabel">Coding Workbench</h6>
                <button type="button" class="close modal-close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <div class="modal-body" style="height: calc(100vh - 190px); overflow-x: auto">
                <div class="alert alert-danger fade show" id="ErrorMessage">
                    <span>Required fields are missing.</span>
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

                <form id="formCoversheet">
                    <center><h6>COVERSHEET DETAILS</h6></center>

                    <div class="row mb-2">
                        <div class="col-md">
                            @Html.Partial("CustomControls/_TextFieldView", new JobTrack.Models.FormFieldModel { Label = "Coversheet Number", Name = "CoversheetNumber", Value = Model.CoversheetNumber, IsReadOnly = true })

                            @Html.Partial("CustomControls/_TextFieldView", new JobTrack.Models.FormFieldModel { Label = "Tier", Name = "CoversheetTier", Value = Model.CoversheetTier, IsReadOnly = true })

                            @Html.Partial("CustomControls/_TextFieldView", new JobTrack.Models.FormFieldModel { Label = "Service Number", Name = "ServiceNumber", Value = Model.ServiceNumber, IsReadOnly = true })

                            @Html.Partial("CustomControls/_TextFieldView", new JobTrack.Models.FormFieldModel { Label = "Task Number", Name = "TaskNumber", Value = Model.TaskNumber, IsReadOnly = true })

                            @Html.Partial("CustomControls/_TextFieldView", new JobTrack.Models.FormFieldModel { Label = "Product ID", Name = "BPSProductID", Value = Model.BPSProductID, IsReadOnly = true })

                            @Html.Partial("CustomControls/_TextFieldView", new JobTrack.Models.FormFieldModel { Label = "Editor", Name = "Editor", Value = Model.Editor, IsReadOnly = true })

                            @Html.Partial("CustomControls/_TextFieldView", new JobTrack.Models.FormFieldModel { Label = "Charge Code", Name = "ChargeCode", Value = Model.ChargeCode, IsReadOnly = true })

                            @Html.Partial("CustomControls/_TextFieldView", new JobTrack.Models.FormFieldModel { Label = "Task Type", Name = "TaskType", Value = Model.TaskType, IsReadOnly = true })

                            @Html.Partial("CustomControls/_TextAreaView", new JobTrack.Models.FormFieldModel { Label = "Manuscript/Legislation/Further Instructions", Name = "LocationOfManuscript", Value = Model.LocationOfManuscript, IsRequired = true, IsReadOnly = true })

                            <center><h6>TASK DETAILS</h6></center>

                            @Html.Partial("CustomControls/_TextFieldView", new JobTrack.Models.FormFieldModel { Label = "Status", Name = "TaskStatus", Value = Model.TaskStatus, IsReadOnly = true })

                            @Html.Partial("CustomControls/_DateEditorView", new JobTrack.Models.FormFieldModel { Label = "Actual Press Date", Name = "ActualPressDate", Value = Model.ActualPressDate, IsReadOnly = true })

                            @Html.Partial("CustomControls/_DateEditorView", new JobTrack.Models.FormFieldModel { Label = "Revised Online Due Date", Name = "RevisedOnlineDueDate", Value = Model.RevisedOnlineDueDate, Class = "datepicker", IsRequired = true, IsReadOnly = true })

                            @Html.Partial("CustomControls/_DateEditorView", new JobTrack.Models.FormFieldModel { Label = "Accepted Date", Name = "AcceptedDate", Value = Model.AcceptedDate, IsReadOnly = true })

                            @if (TempData["JobOwners"] != null)
                            {
                                @Html.Partial("CustomControls/_DropdownListView", new JobTrack.Models.FormFieldModel { Label = "Job Owner", Name = "JobOwnerID", TempDataName = "JobOwners", IsReadOnly = true })
                            }

                            @Html.Partial("CustomControls/_TextFieldView", new JobTrack.Models.FormFieldModel { Label = "Current Task", Name = "CurrentTask", Value = Model.CurrentTask, IsReadOnly = true })

                            @Html.Partial("CustomControls/_TextFieldView", new JobTrack.Models.FormFieldModel { Label = "Update Email CC", Name = "UpdateEmailCC", Value = Model.UpdateEmailCC, IsReadOnly = true })

                            @Html.Partial("CustomControls/_TextFieldView", new JobTrack.Models.FormFieldModel { Label = "Online Timeliness", Name = "OnlineTimeliness", Value = Model.OnlineTimeliness, IsReadOnly = true })

                            @Html.Partial("CustomControls/_TextAreaView", new JobTrack.Models.FormFieldModel { Label = "Remarks", Name = "Remarks", Value = Model.Remarks, IsRequired = true, IsReadOnly = true })

                            @Html.Partial("CustomControls/_TextFieldView", new JobTrack.Models.FormFieldModel { Label = "Date Created", Name = "DateCreated", Value = Model.DateCreated, IsReadOnly = true })

                            @Html.Partial("CustomControls/_TextAreaView", new JobTrack.Models.FormFieldModel { Label = "Guide Card", Name = "GuideCard", Value = Model.GuideCard, IsRequired = true, IsReadOnly = true })
                        </div>

                        <div class="col-md">
                            @if (TempData["UpdateTypes"] != null)
                            {
                                @Html.Partial("CustomControls/_DropdownListView", new JobTrack.Models.FormFieldModel { Label = "Update Types", Name = "UpdateTypes", TempDataName = "UpdateTypes", IsReadOnly = true })
                            }

                            <div class="form-group">
                                <div class="col-sm-12 checkbox-wrapper border" style="padding-top: 5px">
                                    <center><h6>GENERAL</h6></center>

                                    @Html.Partial("CustomControls/_CheckboxView", new JobTrack.Models.FormFieldModel { Name = "GeneralLegRefCheck", Label = "Leg Ref Check", Value = Model.GeneralLegRefCheck, IsReadOnly = true })

                                    @Html.Partial("CustomControls/_CheckboxView", new JobTrack.Models.FormFieldModel { Name = "GeneralTOC", Label = "TOC", Value = Model.GeneralTOC, IsReadOnly = true })

                                    @Html.Partial("CustomControls/_CheckboxView", new JobTrack.Models.FormFieldModel { Name = "GeneralFascicleInsertion", Label = "Fascicle Insertion", Value = Model.GeneralFascicleInsertion, IsReadOnly = true })

                                    @Html.Partial("CustomControls/_CheckboxView", new JobTrack.Models.FormFieldModel { Name = "GeneralGraphicEmbed", Label = "Graphic-Embed", Value = Model.GeneralGraphicEmbed, IsReadOnly = true })

                                    @Html.Partial("CustomControls/_CheckboxView", new JobTrack.Models.FormFieldModel { Name = "GeneralNonContent", Label = "Non-Content", Value = Model.GeneralNonContent, IsReadOnly = true })

                                    @Html.Partial("CustomControls/_CheckboxView", new JobTrack.Models.FormFieldModel { Name = "GeneralComplexTask", Label = "Complex Task", Value = Model.GeneralComplexTask, IsReadOnly = true })

                                    @Html.Partial("CustomControls/_CheckboxView", new JobTrack.Models.FormFieldModel { Name = "GeneralTOS", Label = "TOS", Value = Model.GeneralTOS, IsReadOnly = true })

                                    @Html.Partial("CustomControls/_CheckboxView", new JobTrack.Models.FormFieldModel { Name = "GeneralReprints", Label = "Reprints", Value = Model.GeneralReprints, IsReadOnly = true })

                                    @Html.Partial("CustomControls/_CheckboxView", new JobTrack.Models.FormFieldModel { Name = "GeneralGraphicLink", Label = "Graphic-Link", Value = Model.GeneralGraphicLink, DontDisplay = true })

                                    @Html.Partial("CustomControls/_CheckboxView", new JobTrack.Models.FormFieldModel { Name = "GeneralHandtooling", Label = "Handtooling", Value = Model.GeneralHandtooling, IsReadOnly = true })

                                    @Html.Partial("CustomControls/_CheckboxView", new JobTrack.Models.FormFieldModel { Name = "GeneralSamplePages", Label = "Sample Pages", Value = Model.GeneralSamplePages, IsReadOnly = true })
                                </div>
                            </div>

                            @Html.Partial("CustomControls/_TextFieldView", new JobTrack.Models.FormFieldModel { Label = "Target Press Date", Name = "TargetPressDate", Value = Model.TargetPressDate, IsReadOnly = true })

                            @Html.Partial("CustomControls/_TextAreaView", new JobTrack.Models.FormFieldModel { Label = "Further Instructions", Name = "FurtherInstruction", Value = Model.FurtherInstruction, IsRequired = true, IsReadOnly = true })

                            <center><h6>XML EDITING</h6></center>

                            @Html.Partial("CustomControls/_CheckboxView", new JobTrack.Models.FormFieldModel { Label = "XML Editing ", Name = "IsXMLEditing", Value = Model.IsXMLEditing }) <br />

                            @Html.Partial("CustomControls/_DateEditorView", new JobTrack.Models.FormFieldModel { Label = "Coding - Due Date", Name = "CodingDueDate", Value = Model.CodingDueDate, IsReadOnly = true })

                            @Html.Partial("CustomControls/_TextFieldGroupView", new JobTrack.Models.FormFieldModel { Label = "Coding - Start Date", Name = "CodingStartDate", Value = Model.CodingStartDate, ButtonText = "START", OnClickEvent = "onclickDate(this)", IsReadOnly = true })

                            @Html.Partial("CustomControls/_TextFieldGroupView", new JobTrack.Models.FormFieldModel { Label = "Coding - Done Date", Name = "CodingDoneDate", Value = Model.CodingDoneDate, ButtonText = "DONE", OnClickEvent = "onclickDate(this)", IsReadOnly = true })

                            @Html.Partial("CustomControls/_TextFieldView", new JobTrack.Models.FormFieldModel { Label = "Sub Task", Name = "SubTask", Value = Model.SubTask, IsReadOnly = true })

                            @Html.Partial("CustomControls/_TextFieldGroupView", new JobTrack.Models.FormFieldModel { Label = "PDF QC - Start Date", Name = "PDFQCStartDate", Value = Model.PDFQCStartDate, ButtonText = "START", OnClickEvent = "onclickDate(this)", IsReadOnly = true })

                            @Html.Partial("CustomControls/_TextFieldGroupView", new JobTrack.Models.FormFieldModel { Label = "PDF QC - Done Date", Name = "PDFQCDoneDate", Value = Model.PDFQCDoneDate, ButtonText = "DONE", OnClickEvent = "onclickDate(this)", IsReadOnly = true })

                            @Html.Partial("CustomControls/_TextAreaView", new JobTrack.Models.FormFieldModel { Label = "Completion Email Template", Name = "CompletionEmailTemplate", Value = Model.CompletionEmailTemplate })

                            <!-- attachment -->
                            <div class="form-group">
                                <label>ATTACHMENT (pdf, word, excel, csv, jpeg, png, txt)</label>
                                <input type="file"
                                       class="form-control"
                                       style="font-size: 12px"
                                       onchange="removeRedError(this)"
                                       errorid="error-text-modal"
                                       name="FileToUpload"
                                       id="FileToUpload"
                                       accept=".pdf, .xlsx, .xls, .txt, .docx, .csv, .jpeg, .jpg, .png"
                                       value="@Model.AttachmentFile" />
                            </div>

                            <center><h6>ONLINE</h6></center>

                            @Html.Partial("CustomControls/_CheckboxView", new JobTrack.Models.FormFieldModel { Label = "Online", Name = "IsOnline", Value = Model.IsOnline }) <br />

                            @Html.Partial("CustomControls/_DateEditorView", new JobTrack.Models.FormFieldModel { Label = "Online - Due Date", Name = "OnlineDueDate", Value = Model.OnlineDueDate, IsReadOnly = true })

                            @Html.Partial("CustomControls/_TextFieldGroupView", new JobTrack.Models.FormFieldModel { Label = "Online - Start Date", Name = "OnlineStartDate", Value = Model.OnlineStartDate, ButtonText = "START", OnClickEvent = "onclickDate(this)", IsReadOnly = true })

                            @Html.Partial("CustomControls/_TextFieldGroupView", new JobTrack.Models.FormFieldModel { Label = "Online - Done Date", Name = "OnlineDoneDate", Value = Model.OnlineDoneDate, ButtonText = "DONE", OnClickEvent = "onclickDate(this)", IsReadOnly = true })
                        </div>
                    </div>

                    <!-- hidden values -->
                    <input type="hidden" name="CoversheetID" value="@Model.CoversheetID" />
                    <input type="hidden" name="ManuscriptID" value="@Model.ManuscriptID" />
                    <input type="hidden" name="UserAccess" value="@((int)JobTrack.Models.Enums.UserAccessEnum.Coding)" />
                    <input type="hidden" name="JobOwner" value="@Model.JobOwner" />
                    <input type="hidden" name="JobOwner" value="@Model.JobOwner" id="JobOwner" />
                </form>

                <hr />
                <div class="row">
                    <div class="col-md">
                        <center><h6>HISTORY TRAIL</h6></center>
                        @Html.Partial("CustomControls/_HistoryTrailView", new JobTrack.Models.HistoryTrailModel { ID = Model.CoversheetID, JobType = JobTypeEnum.CoversheetData, TableId = "tblHistoryCoversheet" })
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-success" onclick="onclickSubmit();" id="btnSave">Submit</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        setupDefaultForm();

        $('#JobOwnerID').on('change', function () {
            let url = '@Url.Action("GetUserData", "Coversheet")' + "?selectedItem=" + encodeURIComponent($(this).val());

            GotoControllerAsync(url, 'POST', null, false, 'json', function (response) {
                let emailAddress = response.EmailAddress;
                let userName = response.UserName;

                $('#UpdateEmailCC').val(emailAddress.replace(/['"]+/g, ''));
                $('#JobOwner').val(userName.replace(/['"]+/g, ''));
            });
        });

        let codingStartDateDisabled = '@Model.CodingStartDate.HasValue' == 'True';
        let codingDoneDateDisabled = '@Model.CodingDoneDate.HasValue' == 'True' || ('@Model.CodingStartDate.HasValue' == 'False' && '@Model.CodingDoneDate.HasValue' == 'False');
        let pdfStartDateDisabled = '@Model.PDFQCStartDate.HasValue' == 'True' || ('@Model.CodingDoneDate.HasValue' == 'False' && '@Model.PDFQCStartDate.HasValue' == 'False');
        let pdfDoneDateDisabled = '@Model.PDFQCDoneDate.HasValue' == 'True' || ('@Model.PDFQCStartDate.HasValue' == 'False' && '@Model.PDFQCDoneDate.HasValue' == 'False');
        let onlineStartDateDisabled = '@Model.OnlineStartDate.HasValue' == 'True';
        let onlineDoneDateDisabled = '@Model.OnlineDoneDate.HasValue' == 'True' || ('@Model.OnlineStartDate.HasValue' == 'False' && '@Model.OnlineDoneDate.HasValue' == 'False');

        $('#btnCodingStartDate').prop('disabled', codingStartDateDisabled);
        $('#btnCodingDoneDate').prop('disabled', codingDoneDateDisabled);
        $('#btnPDFQCStartDate').prop('disabled', pdfStartDateDisabled);
        $('#btnPDFQCDoneDate').prop('disabled', pdfDoneDateDisabled);
        $('#btnOnlineStartDate').prop('disabled', onlineStartDateDisabled);
        $('#btnOnlineDoneDate').prop('disabled', onlineDoneDateDisabled);
    });

    function onclickSubmit() {
        let isValid = validateForm('formCoversheet');
        if (isValid) {

            submitFormWithFiles('formCoversheet'
                , '/Coversheet/EditCoversheetData'
                , 'FileToUpload'
                , function (response) {

                if (response.IsSuccess) {
                    window.location.reload();
                }
                else
                    alert("Error: " + response.ErrorMessage);
            });
        }
    }

    function onclickDate(e) {
        let inputId = e.id.replaceAll('btn', '');
        $('#' + inputId).val(new Date().toISOString().split('T')[0]);

        switch (inputId) {
            case 'CodingStartDate':
                $('#btnCodingDoneDate').prop('disabled', false); break

            case 'PDFQCStartDate':
                $('#btnPDFQCDoneDate').prop('disabled', false); break

            case 'OnlineStartDate':
                $('#btnOnlineDoneDate').prop('disabled', false); break
        }

        $('#' + e.id).prop('disabled', true);
    }
</script>